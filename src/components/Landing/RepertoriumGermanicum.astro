---
import { Icon } from 'astro-icon/components';
import { rg2_improved, rg2_normal } from '../../assets';
import Image from 'astro/components/Image.astro';
---

<section class="fullscreen-section" id="repertorium-germanicum" aria-label="Repertorium Germanicum">
  <div class="content-container section-inner flex flex-col items-center justify-center py-20 md:py-0 w-full gap-6 md:gap-10">

    <!-- Section badge -->
    <div class="inline-flex items-center gap-2 bg-purple-500/10 border border-purple-500/20 rounded-full px-4 py-2">
      <Icon name="lucide:book-open" size={14} class="text-purple-400" />
      <span class="text-purple-300 text-xs md:text-sm font-medium">Die Herausforderung</span>
    </div>

    <h2 class="section-title text-2xl sm:text-3xl md:text-5xl text-white text-center -mt-2">
      Die Quelle: Das
      <span class="bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">
        Repertorium Germanicum
      </span>
    </h2>

    <div class="flex flex-col lg:flex-row gap-6 md:gap-10 w-full items-center justify-center">

      <!-- Image compare -->
      <div class="relative w-full max-w-xl lg:max-w-2xl flex-shrink-0">
        <div class="image-compare-container relative rounded-xl overflow-hidden select-none">
          <img src={rg2_improved.src} alt="Repertorium Germanicum Improved" class="w-full h-auto object-contain" />
          <div class="image-overlay absolute inset-0" style="clip-path: inset(0 0 0 100%);">
            <img src={rg2_normal.src} alt="Repertorium Germanicum Original" class="w-full h-full object-contain" />
          </div>
          <div class="slider-line absolute top-0 bottom-0 w-0.5 bg-purple-500 shadow-lg" style="left: 100%;">
            <div class="slider-handle absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full shadow-xl cursor-ew-resize flex items-center justify-center">
              <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
              </svg>
            </div>
          </div>
        </div>
        <p class="text-center text-xs text-slate-400 mt-2">← ziehen zum Vergleichen →</p>
      </div>

      <!-- Facts grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-3 w-full lg:max-w-sm" id="facts">
        <div class="fact-item landing-card flex flex-col gap-1">
          <span class="text-white font-semibold text-sm md:text-base">Strukturierte Tiefenerschließung</span>
          <span class="text-slate-300 text-xs md:text-sm leading-relaxed">Aus unstrukturierten Registereinträgen werden normalisierte Entitäten mit kontrollierten Vokabularen extrahiert.</span>
        </div>
        <div class="fact-item landing-card flex flex-col gap-1">
          <span class="text-white font-semibold text-sm md:text-base">Normdaten & Verknüpfungen</span>
          <span class="text-slate-300 text-xs md:text-sm leading-relaxed">Verbindung zu GND, Geo-Referenzen und FactGrid/Wikibase schafft Linked-Data-Kontext.</span>
        </div>
        <div class="fact-item landing-card flex flex-col gap-1">
          <span class="text-white font-semibold text-sm md:text-base">Wissenschaftliche Nachvollziehbarkeit</span>
          <span class="text-slate-300 text-xs md:text-sm leading-relaxed">Jeder Erschließungsschritt wird modelliert und maschinenlesbar dokumentiert.</span>
        </div>
        <div class="fact-item landing-card flex flex-col gap-1">
          <span class="text-white font-semibold text-sm md:text-base">Analytischer Mehrwert</span>
          <span class="text-slate-300 text-xs md:text-sm leading-relaxed">Ermöglicht Abfragen zu Karrierewegen, Netzwerkbeziehungen und räumlichen Verdichtungen.</span>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const section = document.getElementById('repertorium-germanicum');
    const container = document.querySelector('.image-compare-container');
    const overlay = document.querySelector('.image-overlay') as HTMLElement | null;
    const sliderLine = document.querySelector('.slider-line') as HTMLElement | null;
    const handle = document.querySelector('.slider-handle');
    const factsContainer = document.getElementById('facts');
    const scrollContainer = document.getElementById('presentation-container');

    if (!container || !overlay || !sliderLine || !handle || !section || !factsContainer) return;

    let isDragging = false;

    const setSliderPercentage = (percentage: number) => {
      const p = Math.max(0, Math.min(100, percentage));
      overlay.style.clipPath = `inset(0 0 0 ${p}%)`;
      sliderLine.style.left = `${p}%`;
    };

    const updateSliderFromEvent = (e: MouseEvent | TouchEvent) => {
      const rect = container.getBoundingClientRect();
      const clientX = 'touches' in e ? (e as TouchEvent).touches[0].clientX : (e as MouseEvent).clientX;
      setSliderPercentage(((clientX - rect.left) / rect.width) * 100);
    };

    const removeAnimationClass = () => {
      overlay.classList.remove('slider-animating');
      sliderLine.classList.remove('slider-animating');
    };

    const startDragging = (e: MouseEvent | TouchEvent) => { isDragging = true; removeAnimationClass(); updateSliderFromEvent(e); e.preventDefault(); };
    const stopDragging = () => { isDragging = false; };
    const onMove = (e: MouseEvent | TouchEvent) => { if (isDragging) updateSliderFromEvent(e); };

    handle.addEventListener('mousedown', startDragging as EventListener);
    document.addEventListener('mousemove', onMove as EventListener);
    document.addEventListener('mouseup', stopDragging);
    handle.addEventListener('touchstart', startDragging as EventListener, { passive: false });
    document.addEventListener('touchmove', onMove as EventListener, { passive: false });
    document.addEventListener('touchend', stopDragging);

    container.addEventListener('click', (e) => { if (!isDragging) { removeAnimationClass(); updateSliderFromEvent(e as MouseEvent); } });

    const root = scrollContainer ?? null;
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
          factsContainer.classList.add('is-visible');
          overlay.classList.add('slider-animating');
          sliderLine.classList.add('slider-animating');
          setTimeout(() => setSliderPercentage(25), 50);
          observer.unobserve(section);
        }
      });
    }, { root, threshold: 0.5 });

    observer.observe(section);
  });
</script>

<style>
  .image-compare-container { user-select: none; -webkit-user-select: none; }
  .slider-handle { transition: transform 0.1s ease; }
  .slider-handle:active { transform: translate(-50%, -50%) scale(0.9); }
  .image-overlay.slider-animating { transition: clip-path 1.5s cubic-bezier(0.25, 1, 0.5, 1); }
  .slider-line.slider-animating { transition: left 1.5s cubic-bezier(0.25, 1, 0.5, 1); }

  .fact-item {
    opacity: 0;
    transform: translateX(24px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }
  #facts.is-visible .fact-item { opacity: 1; transform: translateX(0); }
  #facts.is-visible .fact-item:nth-child(1) { transition-delay: 0.15s; }
  #facts.is-visible .fact-item:nth-child(2) { transition-delay: 0.3s; }
  #facts.is-visible .fact-item:nth-child(3) { transition-delay: 0.45s; }
  #facts.is-visible .fact-item:nth-child(4) { transition-delay: 0.6s; }
</style>

