---
import "../styles/tailwind.css";
import "../styles/global.scss";

import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import { SiteTitle } from '../consts';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import NavBar from '../components/Navbar/NavBar.astro';
import { ClientRouter } from 'astro:transitions';
import { Calendar, Clock, Tag, MapPin, Users } from 'lucide-astro';
import Image from 'astro/components/Image.astro';

type Props = {
	blogpost: CollectionEntry<'blog'> | CollectionEntry<'events'> | CollectionEntry<'publications'>;
};

const { blogpost } = Astro.props;
const { data } = blogpost;
const title = `${data.title} | ${SiteTitle}`;
const description = data.description;
const image = 'image' in data ? data.image : undefined;

// Date: blog/publications use `date`, events use `start`
const date = 'date' in data ? data.date
           : 'start' in data ? data.start
           : undefined;

// Collection-specific metadata
const isBlog = blogpost.collection === 'blog';
const isEvent = blogpost.collection === 'events';
const isPub = blogpost.collection === 'publications';

const readTime  = isBlog && 'readTime'  in data ? data.readTime  : undefined;
const category  = isBlog && 'category'  in data ? data.category  : undefined;
const location  = (isBlog || isEvent) && 'location' in data ? (data as any).location : undefined;
const authorIds: string[] = 'authors' in data && data.authors ? data.authors : [];
const venue     = isPub && 'venue' in data ? data.venue : undefined;
const doi       = isPub && 'doi'   in data ? data.doi   : undefined;
const eventEnd  = isEvent && 'end'  in data ? (data as any).end  : undefined;

// Resolve author names from team collection
let authorNames: string[] = [];
if (authorIds.length > 0) {
  const teamMembers = await getCollection('team');
  authorNames = authorIds.map(id => {
    const member = teamMembers.find(m => m.id === id || m.id.startsWith(id));
    return member ? member.data.name : id;
  });
}
---

<!doctype html>
<html lang="de">
	<head>
		<BaseHead title={title} description={description} image={image as any} />
		<ClientRouter />
	</head>
	<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen">
		<div class="glow"></div>
		<NavBar />

		<!-- Hero header -->
		<header class="post-hero relative overflow-hidden pt-28 sm:pt-32 pb-10 px-4 sm:px-6 lg:px-8">
			<!-- subtle radial glow behind title -->
			<div class="pointer-events-none absolute inset-0 flex items-center justify-center">
				<div class="h-96 w-96 rounded-full bg-purple-600/20 blur-3xl"></div>
			</div>

			<!-- hero image strip (if present) -->
			{image && (
				<div class="hero-image-strip max-w-4xl mx-auto mb-8 rounded-2xl overflow-hidden border border-slate-700/50 shadow-2xl">
					<Image src={image.src} alt={image.alt} class="w-full max-h-72 object-cover" />
				</div>
			)}

			<div class="relative max-w-4xl mx-auto text-center">
				<!-- category / collection badge -->
				{(category || isEvent || isPub) && (
					<div class="inline-flex items-center gap-1.5 bg-blue-500/10 border border-blue-500/20 rounded-full px-3 py-1 mb-5">
						<Tag size={12} class="text-blue-400" />
						<span class="text-blue-300 text-xs font-medium uppercase tracking-wider">
							{category ?? (isEvent ? 'Veranstaltung' : 'Publikation')}
						</span>
					</div>
				)}

				<!-- fancy gradient title -->
				<h1 class="post-title text-3xl sm:text-4xl md:text-5xl font-extrabold leading-tight mb-6">
					{title}
				</h1>

				<!-- metadata row -->
				<div class="flex flex-wrap items-center justify-center gap-x-5 gap-y-2 text-slate-400 text-sm">
					{date && (
						<span class="flex items-center gap-1.5">
							<Calendar size={14} class="text-purple-400 shrink-0" />
							<FormattedDate date={date} />
							{eventEnd && (
								<>
									<span class="opacity-50">â€“</span>
									<FormattedDate date={eventEnd} />
								</>
							)}
						</span>
					)}
					{readTime && (
						<span class="flex items-center gap-1.5">
							<Clock size={14} class="text-purple-400 shrink-0" />
							<span>{readTime} Lesezeit</span>
						</span>
					)}
					{location && (
						<span class="flex items-center gap-1.5">
							<MapPin size={14} class="text-purple-400 shrink-0" />
							<span>{location}</span>
						</span>
					)}
					{authorNames.length > 0 && (
						<span class="flex items-center gap-1.5">
							<Users size={14} class="text-purple-400 shrink-0" />
							<span>{authorNames.join(', ')}</span>
						</span>
					)}
					{venue && (
						<span class="flex items-center gap-1.5">
							<Tag size={14} class="text-purple-400 shrink-0" />
							<span>{venue}</span>
						</span>
					)}
				</div>

				{doi && (
					<p class="mt-3 text-xs text-slate-500">
						DOI: <a href={`https://doi.org/${doi}`} class="text-purple-400 hover:text-purple-300 underline" target="_blank" rel="noopener">{doi}</a>
					</p>
				)}
			</div>
		</header>

		<!-- content -->
		<main class="post single max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-24">
			<div class="content prose prose-invert max-w-none">
				<slot />
			</div>
		</main>

		<Footer />
	</body>
</html>

<style>
	/* Fancy gradient title */
	.post-title {
		background: linear-gradient(135deg, #f1f5f9 0%, #a78bfa 50%, #60a5fa 100%);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}

	/* Subtle top border glow on the hero */
	.post-hero::before {
		content: '';
		position: absolute;
		inset-x: 0;
		top: 0;
		height: 1px;
		background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.4), transparent);
	}

	:global(.content h1),
	:global(.content h2),
	:global(.content h3),
	:global(.content h4),
	:global(.content h5) {
		color: #f1f5f9;
	}
	:global(.content p),
	:global(.content li) {
		color: #cbd5e1;
	}
	:global(.content a) {
		color: #a78bfa;
	}
	:global(.content a:hover) {
		color: #c4b5fd;
	}
	:global(.content img) {
		border-radius: 0.75rem;
		border: 1px solid rgba(71, 85, 105, 0.5);
	}
	:global(.content blockquote) {
		border-left-color: rgba(139, 92, 246, 0.6);
		color: #94a3b8;
	}
	:global(.content code) {
		background: rgba(30, 41, 59, 0.6);
		color: #e2e8f0;
		padding: 0.15em 0.4em;
		border-radius: 0.25rem;
	}
	:global(.content pre) {
		background: rgba(15, 23, 42, 0.8);
		border: 1px solid rgba(71, 85, 105, 0.4);
		border-radius: 0.75rem;
	}

	/* hide the h1 rendered inside markdown since we show it as hero */
	:global(.content > div > h1:first-child) {
		display: none;
	}
</style>
